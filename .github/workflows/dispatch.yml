name: ğŸ“¦ Build and Bundle Python App

on:
  workflow_dispatch:
    inputs:
      repo:
        description: 'Repository to clone (e.g. owner/repo)'
        required: false
        default: hmanzur/ci-cd-tutorial-sample-app.git
        type: string

      ref:
        description: 'Git reference (branch, tag, or commit SHA)'
        required: false
        default: main
        type: string

      python_version:
          description: 'Python version to use'
          required: false
          default: '3.13'
          type: string
          
jobs:
  test:
    name: ğŸ§ª Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”„ Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.repo }}
          ref: ${{ inputs.ref }}
          fetch-depth: 0
          
      - name: âš™ï¸ Install system dependencies
        run: sudo apt update && sudo apt install -y libpq-dev gcc

      - name: ğŸ Set up Python Environment
        uses: getsentry/action-setup-venv@v2.1.1
        id: venv
        with:
          python-version: ${{ inputs.python_version }}
          cache-dependency-path: |
            requirements.txt
          install-cmd: pip install -r requirements.txt
          
      - name: ğŸ›  Run database migrations
        run: flask db upgrade

      - name: ğŸ§ª Run unit tests
        run: python -m unittest discover

  bundle: 
    name: ğŸ“¦ Bundle Application
    needs:
      - test
    runs-on: ubuntu-latest
    steps: 
      - name: ğŸ”„ Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.repo }}
          ref: ${{ inputs.ref }}
      
      - name: ğŸ” Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ³ Build Docker image
        run: |
          tag=${GITHUB_REF#refs/tags/}
          tag=${tag:1}
          image=ghcr.io/${GITHUB_REPOSITORY}
          docker build . -t ${image}:${tag} -t ${image}:latest

      - name: ğŸ“¤ Push Docker image to GHCR
        run: |
          tag=${GITHUB_REF#refs/tags/}
          tag=${tag:1}
          image=ghcr.io/${GITHUB_REPOSITORY}
          docker push ${image}:${tag}
          docker push ${image}:latest